apply from: rootDir.toString() + '/config.gradle'
apply from: rootDir.toString() + '/dependencies.gradle'

def checkModuleIsDev(String moduleName) {
    if (zixieIsDebug) println("checkDev:" + moduleName + " is dev true")
    if (zixieModules.contains(moduleName)) {
        return true
    }
    if (moduleName.contains(".")) {
        return false
    }
    boolean moduleIsDev = false
    zixieDevelopModule.split(",").each { projectName ->
        if (moduleName == projectName) {
            if (zixieIsDebug) println("checkDev:" + moduleName + " find with " + projectName)
            moduleIsDev = true
        }
    }
    if (moduleIsDev) {
        if (zixieIsDebug) println("checkDev:" + moduleName + " is dev true")
        zixieModules.add(moduleName)
        return true
    } else {
        boolean hasChildIsDev = false
        if (zixieIsDebug) println("checkDev:" + moduleName)
        if (zixieModuleInfo[moduleName] != null) {
            zixieModuleInfo[moduleName].get("dependenciesList").each { item ->
                if (!item.contains(".") && checkModuleIsDev(item)) {
                    if (zixieIsDebug) println("checkDev:" + moduleName + " dependencies is dev true")
                    hasChildIsDev = true
                }
            }
        }
        return hasChildIsDev
    }
}

def checkModuleDependencies(String moduleA, String moduleB) {
    if (zixieIsDebug) println("checkModuleDependencies:" + moduleA + " " + moduleB)
    if (tempDependenciesList.containsKey(moduleA)) {
        if (tempDependenciesList.get(moduleA).contains(moduleB)) {
            return 1
        }
    }
    if (tempDependenciesList.containsKey(moduleB)) {
        if (tempDependenciesList.get(moduleB).contains(moduleA)) {
            return -1
        }
    }
    if (zixieIsDebug) println("checkModuleDependencies:" + moduleA + " " + moduleB)
    if (null != zixieModuleInfo[moduleA]) {
        if (zixieModuleInfo[moduleA].get("dependenciesList").contains(moduleB)) {
            addToDependencies(moduleA, moduleB)
            return 1
        } else {
            zixieModuleInfo[moduleA].get("dependenciesList").each { item ->
                if (!item.contains(".")) {
                    def result = checkModuleDependencies(item, moduleB)
                    if (result != 0) {
                        return result
                    }
                }
            }
        }
    }

    if (null != zixieModuleInfo[moduleB]) {
        if (zixieModuleInfo[moduleB].get("dependenciesList").contains(moduleA)) {
            addToDependencies(moduleB, moduleA)
            return -1
        } else {
            zixieModuleInfo[moduleB].get("dependenciesList").each { item ->
                if (!item.contains(".")) {
                    def result = checkModuleDependencies(item, moduleA)
                    if (result != 0) {
                        return result
                    }
                }
            }
        }
    }

    return 0
}

ext.tempDependenciesList = new HashMap<String, ArrayList<String>>()

def addToDependencies(String mainModule, String dependenciesModule) {
    if (!tempDependenciesList.containsKey(mainModule)) {
        tempDependenciesList.put(mainModule, new ArrayList<String>())
    }
    tempDependenciesList.get(mainModule).add(dependenciesModule)
    if (tempDependenciesList.containsKey(dependenciesModule)) {
        tempDependenciesList.get(dependenciesModule).each { item ->
            addToDependencies(mainModule, item)
        }
    }
}

def zixiePublishCommand() {
    System.err.println("组件依赖关系处理中，预计耗时较久，请耐心等待...\n\n")

    if (zixieIsDebug) println("showCommand")
    def moduleList = []
    zixieModuleInfo.each { projectName, subModuleList ->
        if (projectName.startsWith("Lib") && checkModuleIsDev(projectName)) {
            moduleList.add(projectName)
        }
    }

    if (moduleList.size() > 0) {
        if (zixieIsDebug) System.err.println("showCommand before :" + moduleList)
        for (int i = 0; i < moduleList.size(); i++) {
            for (int j = 0; j < i; j++) {
                if (zixieIsDebug) println("----- showCommand " + i + " " + j)
                if (zixieIsDebug) println("showCommand " + moduleList.get(i) + " " + moduleList.get(j) + " " + (checkModuleDependencies(moduleList.get(i), moduleList.get(j)) < 0))
                if ((checkModuleDependencies(moduleList.get(i), moduleList.get(j)) < 0)) {
                    def temp = moduleList.get(j + 1)
                    if (zixieIsDebug) println("showCommand before:" + moduleList)
                    moduleList.set(j + 1, moduleList.get(j))
                    moduleList.set(j, temp)
                    if (zixieIsDebug) println("showCommand before:" + moduleList)
                } else {
                    if (zixieIsDebug) println("showCommand noting")
                }
                if (zixieIsDebug) println("----- showCommand " + i + " " + j)
            }
        }

        if (zixieIsDebug) System.err.println("showCommand end :" + moduleList)

        def resultList = "\n"
        moduleList.each { item ->
            resultList = resultList + item + "\n"
        }
        System.err.println("\n\n========================================\n\n")
        System.err.println("当前开发的组件开发修改版本号后，直接在根目录运行下面的命令即可发布所有依赖到最新版本\n")
        System.err.println("运行后升级版本的组件有：\n\n\t" + moduleList)
        System.err.println("\n发布使用的命令： \n\n")

        System.err.println("echo \"" + resultList + "\"  | xargs -I {} /bin/bash ./build_upload.sh {} " + zixieVersionName)
        System.err.println("\n\n========================================\n\n")
    }else {
        System.err.println("组件依赖关系处理已完成，没有组件需要更新...")
    }


}

def autoDependencies(String projectName, String moduleName) {
    if (zixieIsDebug) println("======== autoDependencies " + projectName + " ========")
    if (zixieIsDebug) println("check " + projectName + " depenciese:" + moduleName)
    if (zixieModuleInfo[moduleName] != null) {
        zixieModuleInfo[moduleName].get("dependenciesList").each { item ->
            if (checkModuleIsDev(item)) {
                if (zixieIsDebug) println(projectName + " add source dependencies:" + item)
                project(':' + projectName).dependencies.add("api", project(':' + item + ''))
            } else {
                if (zixieIsDebug) println(projectName + " add aar dependencies:" + item)
//            project(':' + projectName).dependencies.add("api", [name: item + "-release", ext: 'aar'])
                if (item.contains(":")) {
                    project(':' + projectName).dependencies.add("api", item)
                } else {
                    rootProject.zixieUserOrg
                    if (null != zixieModuleInfo[item]) {
                        project(':' + projectName).dependencies.add("api", zixieGroupId + ":" + zixieModuleInfo[item].get("artifactId") + ":" + zixieModuleInfo[item].get("version"))
                    }
                }
            }
            autoDependencies(projectName, item)
        }
    }
    if (zixieIsDebug) println("======== autoDependencies " + projectName + " ========")
    return true

}

ext {
    zixieMainProject = ext.mainProject
    zixieDevelopModule = ext.developModule
    zixieRepoName = "android"
    zixieUserOrg = 'bihe0832'
    zixieGroupId = "com.bihe0832.android"
    zixieLicences = ""
    zixieVersionCode = Integer.parseInt(['sh', '-c', 'git rev-list --all --count'].execute().text.trim())
    zixieVersionName = ext.moduleVersionName
    zixieModuleInfo = ext.moduleInfo
    zixieModules = new ArrayList<>()
    zixieIncludeList = new ArrayList<>()
    zixieIsDebug = false
    zixieIncludeALL = includeALLDependOnDevelopModule
    zixiePublishCommand = this.&zixiePublishCommand
    zixieAutoDependencies = this.&autoDependencies
    checkModuleIsDev = this.&checkModuleIsDev
    checkModuleDependencies = this.&checkModuleDependencies
}
